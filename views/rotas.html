<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Rota Otimizada</title>
    <!-- Fonte -->
    <link
      href="https://fonts.googleapis.com/css2?family=Sofia+Sans:wght@400;700&display=swap"
      rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="../css/rotas.css">
  </head>
  <body>
    <div class="top-bar"></div>

    <div class="side-bar" id="sideBar">
      <img src="../assets/img/logo.png" class="logo" alt="Logo" />
      <div class="monitoramento">
        <span>Monitoramento:</span> Entregas em tempo real
      </div>
      <!-- menu lateral estilizado -->
      <nav class="left-mini-menu" aria-label="Atalhos r√°pidos">
        <ul class="mini-menu-list">
          <li>
            <a href="../views/entregas.php" class="mini-menu-item active">
              <span class="mini-menu-icon">üè†</span>
              <span class="mini-menu-text">In√≠cio</span>
            </a>
          </li>
        </ul>
      </nav>
    </div>

    <div class="main-content">
      <button class="menu-hint" id="menuHint" title="Abrir menu">‚â°</button>
      <h3>Mapa com Rota Otimizada</h3>
      <div class="map-news-container">
        <div style="flex: 1">
          <div id="map"></div>
          <div class="action-buttons">
            <button class="calcular-btn" onclick="enviarPontos()">
              Calcular Rota
            </button>
            <button class="limpar-btn" onclick="limparPontos()">
              Limpar Pontos
            </button>
          </div>
        </div>
        <aside class="news-panel" aria-label="Not√≠cias de Tr√¢nsito">
          <div class="news-header">
            Not√≠cias de Tr√¢nsito
            <div style="display: flex; gap: 6px">
              <button id="refreshNews" title="Atualizar not√≠cias">‚ü≥</button>
              <button id="toggleDebug" title="Mostrar logs">Debug</button>
            </div>
          </div>
          <div class="status-label">Status regional</div>
          <div class="status-bar" aria-hidden="true">
            <div
              id="statusLow"
              class="status-segment"
              style="width: 33%; background: #dff2df"
            ></div>
            <div
              id="statusMedium"
              class="status-segment"
              style="width: 33%; background: #fff0d6"
            ></div>
            <div
              id="statusHigh"
              class="status-segment"
              style="width: 34%; background: #ffe6e6"
            ></div>
          </div>
          <div id="newsList">
            <div style="color: #666">Carregando not√≠cias...</div>
          </div>
        </aside>
      </div>
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-value" id="statHigh">0</div>
          <div class="stat-label">Incidentes graves</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statUpdated">--</div>
          <div class="stat-label">√öltima atualiza√ß√£o</div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
      let map = L.map("map").setView([-23.55, -46.63], 12); // S√£o Paulo
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map
      );

      let pontos = [],
        marcadores = [],
        linhas = [];

      map.on("click", (e) => {
        const coord = { lat: e.latlng.lat, lng: e.latlng.lng };
        pontos.push(coord);
        marcadores.push(L.marker([coord.lat, coord.lng]).addTo(map));
      });

      function enviarPontos() {
        fetch("../backend/calcular_rota.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(pontos),
        })
          .then((resp) => resp.json())
          .then((rota) => desenharLinha(rota.map((p) => [p.lat, p.lng])));
      }

      function desenharLinha(rota) {
        linhas.forEach((l) => map.removeLayer(l));
        linhas = [];
        linhas.push(L.polyline(rota, { color: "blue" }).addTo(map));
      }

      function limparPontos() {
        marcadores.forEach((m) => map.removeLayer(m));
        linhas.forEach((l) => map.removeLayer(l));
        marcadores = [];
        linhas = [];
        pontos = [];
      }

      // Mini menu ativo visual
      document.querySelectorAll(".mini-menu-item").forEach((item) => {
        item.addEventListener("click", function () {
          document
            .querySelectorAll(".mini-menu-item")
            .forEach((i) => i.classList.remove("active"));
          this.classList.add("active");
        });
      });

      function getParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          lat: parseFloat(params.get("lat")),
          lng: parseFloat(params.get("lng")),
          endereco: params.get("endereco"),
        };
      }

      const entrega = getParams();
      if (!isNaN(entrega.lat) && !isNaN(entrega.lng)) {
        map.setView([entrega.lat, entrega.lng], 14);
        L.marker([entrega.lat, entrega.lng])
          .addTo(map)
          .bindPopup(`<b>Entrega</b><br>${entrega.endereco || ""}`)
          .openPopup();
      }
    </script>
  </body>
</html>
